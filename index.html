<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI助手</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chat-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background: #fff;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 85%;
        }
        .user-message {
            background: #e3f2fd;
            text-align: right;
            margin-left: auto;
        }
        .ai-message {
            background: #f5f5f5;
            text-align: left;
            margin-right: auto;
        }
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:active { transform: translateY(1px); }
        .bottom-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .finish-btn {
            background: #4CAF50;
        }
        .copy-btn {
            background: #FF9800;
        }
        #copyNotice {
            display: none;
            color: green;
            margin-left: 8px;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h2>AI助手</h2>
        <p>请与AI助手对话，完成后请点击“复制全部对话”，并将内容粘贴到问卷页面。</p>
        
        <div class="messages" id="messages" aria-live="polite">
            <div class="message ai-message" id="initial-ai">
                您好！我是AI助手，很高兴为您提供帮助。请问有什么我可以协助您的吗？
            </div>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="请输入您的问题..." onkeypress="handleKeyPress(event)" aria-label="输入您的问题">
            <button onclick="sendMessage()">发送</button>
        </div>

        <div class="bottom-actions">
            <button class="copy-btn" onclick="copyChat()">复制全部对话</button>
            <button class="finish-btn" onclick="finishChat()">结束对话并返回问卷</button>
            <span id="copyNotice">✅ 已复制！请返回问卷并粘贴在指定文本框中。</span>
        </div>
    </div>

    <script>
        // 初始会话历史（system + 将要加入的 assistant 欢迎语）
        let conversationHistory = [
            {
                role: 'system',
                content: '你是一个专业的助手，要友好、支持性地回应用户，提供有帮助的支持。每次回复尽量简洁，在200字以内。'
            }
        ];

        // 把页面中初始的 AI 欢迎语也记入 conversationHistory（保证复制时包含欢迎语）
        const initialAiText = document.getElementById('initial-ai').textContent.trim();
        conversationHistory.push({ role: 'assistant', content: initialAiText });

        // 从URL中提取被试编号（如果有）
        const pid = new URLSearchParams(window.location.search).get('pid') || 'unknown';

        // 标记是否已复制（用于阻止未复制就退出）
        let hasCopied = false;

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            if (!message) return;

            // 更新界面和历史
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            userInput.value = '';

            // 添加加载提示（临时）
            const loadingId = addMessage('AI正在思考中...', 'ai', true);

            try {
                // ======= 注意：请将下面的 YOUR_API_KEY_HERE 替换为你的真实 API KEY =======
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + 'sk-8c93bd024f66443f8159d0831583dccc'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: conversationHistory,
                        stream: false,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }

                const data = await response.json();
                removeMessage(loadingId);

                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    addMessage(aiResponse, 'ai');
                    conversationHistory.push({ role: 'assistant', content: aiResponse });
                } else {
                    const errorMsg = '抱歉，我暂时无法回复，请稍后再试。';
                    addMessage(errorMsg, 'ai');
                    conversationHistory.push({ role: 'assistant', content: errorMsg });
                }
            } catch (error) {
                // 移除加载提示并展示错误
                removeMessage(loadingId);
                const errorMsg = '网络连接出现问题，请检查网络后重试。';
                addMessage(errorMsg, 'ai');
                conversationHistory.push({ role: 'assistant', content: errorMsg });
                console.error('sendMessage error:', error);
            }
        }

        function addMessage(content, type, isTemp = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const messageId = isTemp ? 'temp-' + Date.now() : null;

            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = content;
            if (messageId) messageDiv.id = messageId;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageId;
        }

        function removeMessage(id) {
            const element = document.getElementById(id);
            if (element) element.remove();
        }

        // 复制对话（优先从 conversationHistory 构造）
        function copyChat() {
            // 构造要复制的文本（包含被试编号与时间戳）
            const header = `被试编号: ${pid}\n复制时间: ${new Date().toLocaleString()}\n\n`;
            const body = conversationHistory
                .filter(m => m.role !== 'system')
                .map(m => (m.role === 'user' ? '用户: ' : 'AI: ') + m.content)
                .join('\n\n');

            const fullText = header + body;

            // 使用 clipboard API（有些浏览器可能不支持；fallback 到 textarea）
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(fullText).then(() => {
                    hasCopied = true;
                    showCopyNotice();
                }).catch(err => {
                    console.warn('navigator.clipboard 写入失败，使用 fallback:', err);
                    fallbackCopyText(fullText);
                });
            } else {
                fallbackCopyText(fullText);
            }
        }

        // fallback 方法（创建 textarea）
        function fallbackCopyText(text) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                // 避免页面滚动到 textarea
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();

                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);
                if (successful) {
                    hasCopied = true;
                    showCopyNotice();
                } else {
                    alert('复制失败，请手动选中对话并复制。');
                }
            } catch (err) {
                console.error('fallbackCopyText error:', err);
                alert('复制失败，请手动选中对话并复制。');
            }
        }

        function showCopyNotice() {
            const notice = document.getElementById('copyNotice');
            notice.style.display = 'inline';
            // 可选：2.5秒后淡出提示
            setTimeout(() => {
                notice.style.opacity = '1';
                // 留更长时间以便用户看到
            }, 0);
        }

        // 结束对话并返回问卷：如果未复制则阻止并提示
        function finishChat() {
            if (!hasCopied) {
                alert('请先点击复制对话再退出此页面');
                return;
            }

            const endTime = new Date().toISOString();
            console.log('对话结束时间:', endTime);

            // 提示用户并返回
            alert('对话已结束，正在返回问卷页面。');
            // 如果是从问卷跳转过来的，优先返回 referrer（替换“您的问卷域名”为实际域名片段）
            if (document.referrer && document.referrer.includes('您的问卷域名')) {
                window.location.href = document.referrer;
            } else {
                // 你也可以在这里直接跳转到一个指定的问卷 URL，例如：
                // window.location.href = 'https://your-survey-domain.com/return-page';
                // 暂时尝试关闭窗口（注意：window.close 在多数浏览器中只有在窗口由脚本打开时才有效）
                window.close();
            }
        }

        // 在用户尝试关闭或刷新页面时，提醒未复制的用户（可选的额外保护）
        window.addEventListener('beforeunload', function (e) {
            if (!hasCopied) {
                const confirmationMessage = '您尚未复制对话内容。请先点击“复制全部对话”并粘贴到问卷后再离开。';
                (e || window.event).returnValue = confirmationMessage; // Gecko + IE
                return confirmationMessage; // Webkit, Safari, Chrome
            }
            // 否则允许关闭
            return undefined;
        });
    </script>
</body>
</html>
