<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI助手</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chat-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        /* =========== 聊天框滚动修复后的关键样式 =========== */
        .messages {
            height: 400px; /* 固定的高度，让内容可以超出 */
            /* 核心修复：将 overflow-y 从 auto 改为 scroll */
            /* auto：仅在需要时显示滚动条；scroll：总是显示滚动条 */
            overflow-y: scroll; 
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background: #fff;
        }
        /* ================================================= */
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 85%;
        }
        .user-message {
            background: #e3f2fd;
            text-align: right;
            margin-left: auto;
        }
        .ai-message {
            background: #f5f5f5;
            text-align: left;
            margin-right: auto;
        }
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            /* 确保对齐 */
            align-items: flex-end; 
        }

        /* 关键修改：将 input 样式应用于 textarea */
        textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: none; /* 禁用用户手动调整大小 */
            min-height: 40px; /* 初始高度，保持和按钮对齐 */
            overflow-y: hidden; /* 默认隐藏滚动条，由 JS 控制高度 */
            line-height: 1.5; /* 设置行高，让内容看起来更舒服 */
        }

        button {
            padding: 10px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            /* 保证按钮高度与 textarea 的最小高度对齐 */
            height: 40px; 
            box-sizing: border-box; 
            line-height: 20px; /* 调整行高使文字居中 */
        }
        button:active { transform: translateY(1px); }
        .bottom-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .finish-btn {
            background: #4CAF50;
        }
        .copy-btn {
            background: #FF9800;
        }
        #copyNotice {
            display: none;
            color: green;
            margin-left: 8px;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h2>AI助手</h2>
        <p>请与AI助手对话，完成后请点击“复制全部对话”，并将内容粘贴到问卷页面。</p>
        
        <div class="messages" id="messages" aria-live="polite">
            <div class="message ai-message" id="initial-ai">
您好，我是您的AI助手。为了能最高效地协助您，请在提出需求时，尽可能清晰地告诉我以下信息：
【角色】 - 您希望我扮演谁？
【背景】 - 相关的背景情况是什么？
【任务】 - 您需要我具体完成什么？
【要求】 - 需要达到什么标准或注意什么？
【输出】 - 您希望最终的成果是什么格式？
请开始告诉我您的需求吧！
            </div>
        </div>
        
        <div class="input-area">
            <textarea id="userInput" placeholder="请输入您的问题..." rows="1" aria-label="输入您的问题"></textarea>
            <button onclick="sendMessage()">发送</button>
        </div>

        <div class="bottom-actions">
            <button class="copy-btn" onclick="copyChat()">复制全部对话</button>
            <button class="finish-btn" onclick="finishChat()">结束对话并返回问卷</button>
            <span id="copyNotice">✅ 已复制！请返回问卷并粘贴在指定文本框中。</span>
        </div>
    </div>

    <script>
        // 初始会话历史（system + 将要加入的 assistant 欢迎语）
        let conversationHistory = [
            {
                role: 'system',
                content: '你是一个专业的助手，要友好、支持性地回应用户，提供有帮助的支持。每次回复尽量简洁，在200字以内。'
            }
        ];

        // 获取 DOM 元素
        const userInput = document.getElementById('userInput');
        const messagesDiv = document.getElementById('messages');
        const initialAiText = document.getElementById('initial-ai').textContent.trim();

        // 把页面中初始的 AI 欢迎语也记入 conversationHistory（保证复制时包含欢迎语）
        conversationHistory.push({ role: 'assistant', content: initialAiText });

        // 从URL中提取被试编号（如果有）
        const pid = new URLSearchParams(window.location.search).get('pid') || 'unknown';

        // 标记是否已复制（用于阻止未复制就退出）
        let hasCopied = false;

        // =========================================================
        // 新增功能 1: 自动调整 textarea 高度的函数
        // =========================================================
        function autoResize() {
            // 重置高度为 1 行，以便准确计算新的scrollHeight
            userInput.style.height = 'auto'; 
            
            // 计算新的高度，不超过最大高度（例如 200px，防止无限大）
            const newHeight = Math.min(userInput.scrollHeight, 200); 
            
            // 应用新高度
            userInput.style.height = newHeight + 'px';
        }

        // =========================================================
        // 新增功能 2: 监听输入事件和回车事件
        // =========================================================
        userInput.addEventListener('input', autoResize); // 监听输入事件，实时调整高度

        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) { // 按 Enter 键发送，按 Shift+Enter 换行
                event.preventDefault(); // 阻止默认的 Enter 行为（换行）
                sendMessage();
            }
        });
        
        // 确保页面加载时输入框的初始高度正确
        window.addEventListener('load', autoResize); 


        // =========================================================
        // 原有功能 - 发送消息
        // =========================================================
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // 更新界面和历史
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            userInput.value = '';
            
            // 关键：发送后重置输入框高度
            autoResize(); 

            // 添加加载提示（临时）
            const loadingId = addMessage('AI正在思考中...', 'ai', true);

            try {
                // ======= 注意：请将下面的 API KEY 替换为你的真实 API KEY =======
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + 'sk-8c93bd024f66443f8159d0831583dccc'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: conversationHistory,
                        stream: false,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }

                const data = await response.json();
                removeMessage(loadingId);

                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    addMessage(aiResponse, 'ai');
                    conversationHistory.push({ role: 'assistant', content: aiResponse });
                } else {
                    const errorMsg = '抱歉，我暂时无法回复，请稍后再试。';
                    addMessage(errorMsg, 'ai');
                    conversationHistory.push({ role: 'assistant', content: errorMsg });
                }
            } catch (error) {
                // 移除加载提示并展示错误
                removeMessage(loadingId);
                const errorMsg = '网络连接出现问题，请检查网络后重试。';
                addMessage(errorMsg, 'ai');
                conversationHistory.push({ role: 'assistant', content: errorMsg });
                console.error('sendMessage error:', error);
            }
        }
        
        // 由于我们将 input 替换成了 textarea，并且移除了 handleKeyPress 的单独函数
        // 我们需要把这个函数留在 global scope 供 <button onclick="sendMessage()"> 调用
        window.sendMessage = sendMessage;


        function addMessage(content, type, isTemp = false) {
            const messageDiv = document.createElement('div');
            const messageId = isTemp ? 'temp-' + Date.now() : null;

            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = content;
            if (messageId) messageDiv.id = messageId;

            messagesDiv.appendChild(messageDiv);
            // 关键：每发送一条新消息，自动滚动到底部
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageId;
        }

        function removeMessage(id) {
            const element = document.getElementById(id);
            if (element) element.remove();
        }

        // =========================================================
        // 原有功能 - 复制对话、结束对话
        // =========================================================

        // 复制对话（优先从 conversationHistory 构造）
        function copyChat() {
            // 构造要复制的文本（包含被试编号与时间戳）
            const header = `被试编号: ${pid}\n复制时间: ${new Date().toLocaleString()}\n\n`;
            const body = conversationHistory
                .filter(m => m.role !== 'system')
                .map(m => (m.role === 'user' ? '用户: ' : 'AI: ') + m.content)
                .join('\n\n');

            const fullText = header + body;

            // 使用 clipboard API（有些浏览器可能不支持；fallback 到 textarea）
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(fullText).then(() => {
                    hasCopied = true;
                    showCopyNotice();
                }).catch(err => {
                    console.warn('navigator.clipboard 写入失败，使用 fallback:', err);
                    fallbackCopyText(fullText);
                });
            } else {
                fallbackCopyText(fullText);
            }
        }
        
        // 必须将函数暴露给全局作用域，以便 HTML 元素的 onclick 调用
        window.copyChat = copyChat;


        // fallback 方法（创建 textarea）
        function fallbackCopyText(text) {
            try {
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = text;
                // 避免页面滚动到 textarea
                tempTextarea.style.position = 'fixed';
                tempTextarea.style.left = '-9999px';
                document.body.appendChild(tempTextarea);
                tempTextarea.focus();
                tempTextarea.select();

                const successful = document.execCommand('copy');
                document.body.removeChild(tempTextarea);
                if (successful) {
                    hasCopied = true;
                    showCopyNotice();
                } else {
                    alert('复制失败，请手动选中对话并复制。');
                }
            } catch (err) {
                console.error('fallbackCopyText error:', err);
                alert('复制失败，请手动选中对话并复制。');
            }
        }

        function showCopyNotice() {
            const notice = document.getElementById('copyNotice');
            notice.style.display = 'inline';
            notice.style.opacity = '1';
            // 可选：2.5秒后淡出提示
            // setTimeout(() => { notice.style.opacity = '0'; }, 2500); 
        }

        // 结束对话并返回问卷：如果未复制则阻止并提示
        function finishChat() {
            if (!hasCopied) {
                alert('请先点击复制对话再退出此页面');
                return;
            }

            const endTime = new Date().toISOString();
            console.log('对话结束时间:', endTime);

            // 提示用户并返回
            alert('对话已结束，正在返回问卷页面。');
            // 如果是从问卷跳转过来的，优先返回 referrer（替换“您的问卷域名”为实际域名片段）
            if (document.referrer && document.referrer.includes('您的问卷域名')) {
                window.location.href = document.referrer;
            } else {
                // 暂时尝试关闭窗口（注意：window.close 在多数浏览器中只有在窗口由脚本打开时才有效）
                window.close();
            }
        }
        
        // 必须将函数暴露给全局作用域，以便 HTML 元素的 onclick 调用
        window.finishChat = finishChat;

        // 在用户尝试关闭或刷新页面时，提醒未复制的用户（可选的额外保护）
        window.addEventListener('beforeunload', function (e) {
            if (!hasCopied) {
                const confirmationMessage = '您尚未复制对话内容。请先点击“复制全部对话”并粘贴到问卷后再离开。';
                (e || window.event).returnValue = confirmationMessage; // Gecko + IE
                return confirmationMessage; // Webkit, Safari, Chrome
            }
            // 否则允许关闭
            return undefined;
        });
    </script>
</body>
</html>
